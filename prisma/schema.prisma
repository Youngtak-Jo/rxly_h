generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Session {
  id          String        @id @default(uuid())
  userId      String        @map("user_id")
  title       String?
  patientName String?       @map("patient_name")
  startedAt   DateTime      @default(now()) @map("started_at")
  endedAt     DateTime?     @map("ended_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  transcriptEntries TranscriptEntry[]
  insights          Insights?
  record            ConsultationRecord?
  checklistItems    ChecklistItem[]
  diagnoses         Diagnosis[]
  notes             Note[]
  researchMessages  ResearchMessage[]

  @@index([userId])
  @@map("sessions")
}

enum Speaker {
  DOCTOR
  PATIENT
  UNKNOWN
}

model TranscriptEntry {
  id         String   @id @default(uuid())
  sessionId  String   @map("session_id")
  speaker    Speaker
  text       String
  startTime  Float    @map("start_time")
  endTime    Float    @map("end_time")
  confidence Float    @default(0)
  isFinal    Boolean  @default(false) @map("is_final")
  createdAt  DateTime @default(now()) @map("created_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, startTime])
  @@index([sessionId, isFinal, startTime])
  @@map("transcript_entries")
}

model Insights {
  id                  String    @id @default(uuid())
  sessionId           String    @unique @map("session_id")
  summary             String    @default("")
  keyFindings         Json      @default("[]") @map("key_findings")
  redFlags            Json      @default("[]") @map("red_flags")
  diagnosticKeywords  Json      @default("[]") @map("diagnostic_keywords")
  lastProcessedAt     DateTime? @map("last_processed_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("insights")
}

model ChecklistItem {
  id            String          @id @default(uuid())
  sessionId     String          @map("session_id")
  label         String
  isChecked     Boolean         @default(false) @map("is_checked")
  isAutoChecked Boolean         @default(false) @map("is_auto_checked")
  doctorNote    String?         @map("doctor_note")
  sortOrder     Int             @default(0) @map("sort_order")
  source        ChecklistSource @default(AI)
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, sortOrder])
  @@map("checklist_items")
}

enum ChecklistSource {
  AI
  MANUAL
}

model ConsultationRecord {
  id             String   @id @default(uuid())
  sessionId      String   @unique @map("session_id")
  date           DateTime @default(now())
  patientName    String?  @map("patient_name")
  chiefComplaint String?  @map("chief_complaint")
  hpiText        String?  @map("hpi_text")
  medications    String?
  rosText        String?  @map("ros_text")
  pmh            String?
  socialHistory  String?  @map("social_history")
  familyHistory  String?  @map("family_history")
  vitals         Json?
  physicalExam   String?  @map("physical_exam")
  labsStudies    String?  @map("labs_studies")
  assessment     String?
  plan           String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("consultation_records")
}

model Note {
  id           String     @id @default(uuid())
  sessionId    String     @map("session_id")
  content      String
  imageUrls    Json       @default("[]") @map("image_urls")
  storagePaths Json       @default("[]") @map("storage_paths")
  source       NoteSource @default(MANUAL)
  createdAt    DateTime   @default(now()) @map("created_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("notes")
}

enum NoteSource {
  MANUAL
  STT
  IMAGE
}

model ResearchMessage {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  role      String   // "user" or "assistant"
  content   String
  citations Json     @default("[]")
  createdAt DateTime @default(now()) @map("created_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("research_messages")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  action     String   // CREATE, READ, UPDATE, DELETE
  resource   String   // session, transcript, record, insights, diagnosis, note, research, upload, etc.
  resourceId String?  @map("resource_id")
  sessionId  String?  @map("session_id")
  metadata   Json?
  success    Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([sessionId, createdAt])
  @@index([resource, action])
  @@map("audit_logs")
}

model ExportLink {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  sessionId   String   @map("session_id")
  content     String   // encrypted HTML content
  expiresAt   DateTime @map("expires_at")
  accessCount Int      @default(0) @map("access_count")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("export_links")
}

enum DiagnosisConfidence {
  HIGH
  MODERATE
  LOW
}

model Diagnosis {
  id          String              @id @default(uuid())
  sessionId   String              @map("session_id")
  icdCode     String              @map("icd_code")
  icdUri      String?             @map("icd_uri")
  diseaseName String              @map("disease_name")
  confidence  DiagnosisConfidence @default(MODERATE)
  evidence    String
  citations   Json                @default("[]")
  sortOrder   Int                 @default(0) @map("sort_order")
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, sortOrder])
  @@map("diagnoses")
}
